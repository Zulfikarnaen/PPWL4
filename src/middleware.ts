import { Elysia } from "elysia"
import { openapi } from "@elysiajs/openapi";

const app = new Elysia()
.use(openapi())
// Global Logger
app.onRequest(({ request }) => {
 console.log("ðŸ“¥", request.method, request.url)
 console.log("ðŸ•’", new Date().toISOString())
})

app.get("/", () => "Hello Middleware")

app.onRequest(({ request, set }) => {
  if (request.headers.get("x-block") === "true") {
    set.status = 403
    return { message: "Blocked" }
  }
})

// handler harus diletakkan sebelum route
app.onAfterHandle(({ response }) => {
 return {
   success: true,
   data: response
 }
})

app.get("/dashboard",
 () => ({
   message: "Welcome to Dashboard"
 }),
 {
   beforeHandle({ headers, set }) {
     if (!headers.authorization) {
       set.status = 401
       return {
         success: false,
         message: "Unauthorized"
       }
     }
   }
 }
)

app.get("/admin",
    () => ({
    stats: 99
    }),
    {
    beforeHandle({ headers, set }) {
        if (headers.authorization !== "Bearer 123") {
        set.status = 401
        return {
            success: false,
            message: "Unauthorized"
        }
        }
    }
    }
    )

app.get("/profile", () => ({
  name: "Nama kamu"
  }))

app.listen(3000)
console.log("Server running at http://localhost:3000")